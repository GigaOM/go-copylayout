<?php
/*
Plugin Name: Copy Layout
Plugin URI: http://
Description: Copy a 9spot layout and all widgets between blogs
Version: 1.0
Author: Adam Backstrom
Author URI: http://www.plymouth.edu/
License: GPL2
*/

class CopyLayout {
	/**
	 * Add the "Copy Layout" link to the admin sidebar.
	 */
	public static function admin_menu() {
		add_management_page('Copy Layout', 'Copy Layout', 'edit_themes', 'copy-layout', 'CopyLayout::page');
	}//end admin_menu

	/**
	 *
	 */
	public static function get_options( $args = '' ) {
		$args = self::fixup_args($args);

		$options = get_alloptions();

		$return = array();

		if( in_array('sidebars_widgets', $args['which']) ) {
			$return['sidebars_widgets'] = $options->sidebars_widgets;
		}

		$do_widgets = in_array('widgets', $args['which']);
		$do_nines = in_array('nines', $args['which']);

		$nines = $widgets = array();

		foreach( $options as $name => $value ) {
			if( $do_widgets && 'widget_' === substr($name, 0, 7) ) {
				$widgets[$name] = $value;
			} elseif( $do_nines && 'nines-' === substr($name, 0, 6) ) {
				$nines[$name] = $value;
			}
		}

		if( $do_widgets ) {
			$return['widgets'] = $widgets;
		}

		if( $do_nines ) {
			$return['nines'] = $nines;
		}

		// array is full, return it
		
		$return = serialize($return);

		if( $args['base64'] ) {
			$return = base64_encode($return);
		}

		return $return;
	}//end get_options

	/**
	 *
	 */
	public static function fixup_args( $args = '' ) {
		$defaults = array(
			'which' => 'sidebars_widgets,widgets,nines',
			'base64' => true
		);

		$args = wp_parse_args( $args, $defaults );

		if( is_string($args['which']) ) {
			$args['which'] = explode(',', $args['which']);
		}

		return $args;
	}//end fixup_args

	/**
	 * Replace the current layout with a user-submitted layout.
	 */
	public static function replace_layout( $layout ) {
		echo '<div class="wrap"><h2>Applying New Layout</h2><div class="content-container">';

		$layout = base64_decode($layout);

		if( false === $layout ) {
			wp_die( 'Error during Base64 decoding. <a href="tools.php?page=copy-layout">Go back</a>?' );
		}

		$layout = unserialize($layout);

		if( false === $layout ) {
			wp_die( 'Error during unserialize operation. <a href="tools.php?page=copy-layout">Go back</a>?' );
		}

		$options = get_alloptions();

		//
		// what do we have in the incoming array?
		//

		$has_widgets = isset($layout['widgets']);
		$has_nines = isset($layout['nines']);
		$has_sidebars = isset($layout['sidebars_widgets']);

		//
		// delete things that need to be replaced
		//

		echo '<h3>Deleting options...</h3><ol>';

		if( $has_sidebars ) {
			echo '<li>Deleting sidebar_widgets...</li>';
			delete_option('sidebars_widgets');
		}
		
		foreach($options as $name => $value) {
			if( $has_widgets && 'widget_' === substr($name, 0, 7) ) {
				echo '<li>Deleting ' . esc_html($name) . '...</li>';
				delete_option($name);
			} elseif( $has_nines && 'nines-' === substr($name, 0, 6) ) {
				echo '<li>Deleting ' . esc_html($name) . '...</li>';
				delete_option($name);
			}
		}

		echo '</ol>';

		//
		// add layout pieces back in
		//
		//
		echo '<h3>Adding options...</h3><ol>';

		if( $has_sidebars ) {
			echo '<li>Adding sidebar_widgets...</li>';
			add_option('sidebars_widgets', $layout['sidebars_widgets'], '', 'yes');
		}

		foreach($layout['widgets'] as $name => $value) {
			echo '<li>Adding ' . esc_html($name) . '...</li>';
			add_option($name, $value, '', 'yes');
		}

		foreach($layout['nines'] as $name => $value) {
			echo '<li>Adding ' . esc_html($name) . '...</li>';
			add_option($name, $value, '', 'yes');
		}

		echo '</div></div>';
	}

	/**
	 * Display the page getting/setting the layout.
	 */
	public static function page() {
		if( !current_user_can('edit_themes') ) {
			wp_die( __('You do not have sufficient permissions to access this page.') );
		}

		if( isset($_POST['layout']) ) {
			return self::replace_layout( $_POST['layout'] );
		}

		$args = self::fixup_args();

		$current = self::get_options( $args );

		?>

<div class="wrap">
<h2>Copy Layout</h2>
<div class="content-container">
<h3>Current Layout (Read Only)</h3>
<p>Copy this block to save the current layout for archiving or applying to another blog.</p>
<textarea cols="100" rows="15"><?php echo esc_html($current); ?></textarea><br/>
<!--
<label for="sidebars_widgets">Sidebars Widgets</label> <input type="checkbox" name="sidebars_widgets" <?php echo in_array('sidebars_widgets', $args['which']) ? 'checked="checked"' : ''; ?>>
<label for="widgets">Widgets</label> <input type="checkbox" name="widgets" <?php echo in_array('widgets', $args['which']) ? 'checked="checked"' : ''; ?>>
<label for="nines">9spot Layouts</label> <input type="checkbox" name="nines" <?php echo in_array('nines', $args['which']) ? 'checked="checked"' : ''; ?>><br/>
<label for="base64">Base64 Encode</label> <input type="checkbox" name="base64" <?php echo $args['base64'] ? 'checked="checked"' : ''; ?>><br/>
-->
<h3>Replace Layout</h3>
<p>Paste a saved layout here to override the current layout.</p>
<form action="tools.php?page=copy-layout" method="post">
<textarea cols="100" rows="15" name="layout"></textarea><br/>
<p class="submit">
<input type="submit" value="Save" class="button-primary"/>
</p>
</form>
<h3>Todo</h3>
<ul>
	<li>Copy custom CSS?</li>
</ul>
</div>
</div>

		<?php
	}
}//end class CopyLayout

add_action('admin_menu', 'CopyLayout::admin_menu');
